## Fastcgi相关流程

CGI描述的时客户端和服务器之间传输数据的一种标注，可以让一个客户端从网页浏览器向执行在网络服务器上的程序请求数据。

### 处理请求流程

1. server收到http request，之后启动cgi程序，并通过环境变量和标准输入等传入数据
2. CGI进程启动解析器、加载配置(如业务相关配置)、连接其它服务器(如数据库服务器)、逻辑处理等
3. CGI进程将处理结果通过标准输出、标准错误，传递给web服务器
4. web服务器收到CGI返回的结果，构建Http Response返回给客户端，并杀死CGI进程

web服务器与CGI通过环境变量、标准输⼊、标准输出、标准错误互相传递数据。

在遇到⽤户连接请求：

+ 先要创建CGI⼦进程，然后CGI⼦进程处理请求，处理完事退出这个⼦进程：fork-and-execute
+ CGI⽅式是客户端有多少个请求，就开辟多少个⼦进程，每个⼦进程都需要启动⾃⼰的解释器、加载配 置，连接其他服务器等初始化⼯作，这是CGI进程性能低下的主要原因。当⽤户请求⾮常多的时候，会占⽤⼤量的内存、cpu等资源，造成性能低下。

### 关于环境变量

项目中只用到了

| CONTENT_LENGTH | 由标准输⼊传递给CGI程序的数据⻓度，以bytes或字元数来计算     |
| -------------- | ------------------------------------------------------------ |
| QUERY_STRING   | 传递给CGI程序的请求参数，也就是⽤"?"隔开，添加在URL 后⾯的字串 |

比如，GET请求，它将数据打包放置在环境变量QUERY_STRING中，CGI从环境变量QUERY_STRING中获取数 据。

环境变量的⼤⼩是有⼀定的限制的，当需要传送的数据量⼤时，储存环境变量的空间可能会不⾜，造成数 据接收不完全，甚⾄⽆法执⾏CGI程序。

POST让CGI程序可以由stdin和 stdout直接跟浏览器沟通。

这种收到的数据会直接放在一块缓冲区中，大小由CONTENT_LENGTH记录。比较容易的拿到了全部的信息。

### FastCgi

FastCGI致⼒于减少Web服务器与CGI程式之间互动的开销，从⽽使服务器可以同时处理更多的Web请 求。与为每个请求创建⼀个新的进程不同，FastCGI使⽤持续的进程来处理⼀连串的请求。这些进程由 FastCGI进程管理器管理，⽽不是web服务器。

这种的处理有点类似进程池

### spawn-fcgi

Nginx不能像Apache那样直接执⾏外部可执⾏程序，但Nginx可以作为代理服务器，将请求转发给后端服 务器，这也是Nginx的主要作⽤之⼀。其中Nginx就⽀持FastCGI代理，接收客户端的请求，然后将请求转 发给后端FastCGI进程。

由于FastCGI进程由FastCGI进程管理器管理，⽽不是Nginx。这样就需要⼀个FastCGI进程管理器，管理 我们编写FastCGI程序。

spawn-fcgi是⼀个通⽤的FastCGI进程管理器，简单⼩巧，原先是属于lighttpd的⼀部分，后来由于使⽤ ⽐较⼴泛，所以就迁移出来作为独⽴项⽬。

pawn-fcgi使⽤pre-fork 模型，功能主要是打开监听端⼝，绑定地址，然后fork-and-exec创建我们编 写的FastCGI应⽤程序进程，退出完成⼯作。FastCGI应⽤程序初始化，然后进⼊死循环侦听socket的连 接请求。