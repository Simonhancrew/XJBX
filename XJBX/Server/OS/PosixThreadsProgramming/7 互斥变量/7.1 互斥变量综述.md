# 互斥变量综述

mutex是互斥的缩写。互斥变量是实现线程同步和在多次写入中保护共享数据的主要方法之一。

互斥变量就像一把锁，保护对共享资源的访问权。Pthread中使用互斥锁的基本概念就是任何事件中，只有一个线程可以锁定（或拥有）一个互斥锁变量。因此，多个线程试图锁定一个互斥锁的时候，只有一个线程会成功。其余线程无法获得该锁，直到持有锁的线程释放这个互斥锁。线程必须轮流访问受保护的数据。

| Thread 1                  | Thread 2                  | Balance |
| ------------------------- | ------------------------- | ------- |
| Read balance: $1000       |                           | $1000   |
|                           | Read balance: $1000       | $1000   |
|                           | Deposit $200              | $1000   |
| Deposit $200              |                           | $1000   |
| Update balance $1000+$200 |                           | $1200   |
|                           | Update balance $1000+$200 | $1200   |

在上面的例子中，当一个线程在使用这个共享资源的时候，他必须对Balance这个值加锁。

拥有互斥锁的线程执行的操作通常是更新全局变量。这是一种安全的方法，可确保当多个线程同时更新一个变量的时候，最终值和只有一个线程执行更新的值相同。正在更新的变量属于临界区。

使用互斥锁的典型顺序如下：

+ 创建和初始化互斥锁
+ 多个线程试图获取互斥锁
+ 只有一个线程成功，并且获取到互斥锁
+ 持有锁的线程进行一些操作
+ 持有锁的线程释放锁
+ 另一个线程获取到这个互斥锁，重复前三个过程
+ 最终这个互斥锁被销毁

当多个线程同时竞争一把锁的时候，失败者会在这个调用过程中保持阻塞，可以使用trylock而不是lock进行一个非阻塞调用。

当保护共享数据的时候，程序员有责任确保需要使用互斥锁的每个线程都这样做。例如，如果4个线程在更新一个数据，只有一个线程使用了互斥锁，这个数据仍然可能发生冲突

