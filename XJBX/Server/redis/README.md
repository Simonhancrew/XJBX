# Intro To Redis

+ [How to use](./HowtoUse/README.md)
+ [SourcecodeLearning](./SourceCodeStudy/README.md)

## 如何学习redis源码

+ 首先我觉得阅读源码要分模块和需求去学习。这里既是自底向上，先去看耦合关系最小的模块
+ 然后就是如果当前的版本看不懂的话可以checkout前面的几个version去阅读。
+ 之后就是从功能入手，定位到一个功能的具体实现，之后去了解实现方式。
+ 最后自顶向下，从main函数出发，按照使用实际情况看代码。

## redis源码我的学习顺序

首先，`redis`实现了很多的数据结构，这些大多都是从复杂度的角度出发的（算法的时间复杂度）。阅读的时候要做对比的思考，为什么要这么做？

+ 阅读Redis的数据结构部分，基本位于如下文件中：内存分配 zmalloc.c和zmalloc.h

+ 动态字符串 sds.h和sds.c

+ 双端链表 adlist.c和adlist.h

+ 字典 dict.h和dict.c

+ 跳跃表 server.h文件里面关于zskiplist结构和zskiplistNode结构，以及t_zset.c中所有zsl开头的函数，比如 zslCreate、zslInsert、zslDeleteNode等等。

+ 基数统计 hyperloglog.c 中的 hllhdr 结构， 以及所有以 hll 开头的函数

之后，阅读内存压缩的结构，就是encoding。内存编码数据结构不容易找到相关的资料学习， 因为这些数据结构都是 Redis 为了节约内存而专门开发出来的， 换句话说， 这些数据结构都是特制（adhoc）的， 除了 Redis 源码中的文档之外， 基本上找不到其他资料来了解这些特制的数据结构。

+ intset.h 和 intset.c：整数集合（intset）数据结构。


+ ziplist.h 和 ziplist.c：压缩列表（zip list）数据结构。


第三步，我们前面读了所有的底层数据结构，下一步，我们需要知道redis如何通过以上的数据结构实现不同类型的键。

| 文件                                             | 内容                           |
| :----------------------------------------------- | :----------------------------- |
| `object.c`                                       | Redis 的对象（类型）系统实现。 |
| `t_string.c`                                     | 字符串键的实现。               |
| `t_list.c`                                       | 列表键的实现。                 |
| `t_hash.c`                                       | 散列键的实现。                 |
| `t_set.c`                                        | 集合键的实现。                 |
| `t_zset.c` 中除 `zsl` 开头的函数之外的所有函数。 | 有序集合键的实现。             |
| `hyperloglog.c` 中所有以 `pf` 开头的函数。       | HyperLogLog 键的实现。         |

第四步，阅读数据库实现相关的代码

我们了解了数据结构和实现键之后，就可以阅读关于redis的数据库实现代码了。

| 文件                                                   | 内容                             |
| :----------------------------------------------------- | :------------------------------- |
| `redis.h` 文件中的 `redisDb` 结构， 以及 `db.c` 文件。 | Redis 的数据库实现。             |
| `notify.c`                                             | Redis 的数据库通知功能实现代码。 |
| `rdb.h` 和 `rdb.c`                                     | Redis 的 RDB 持久化实现代码。    |
| `aof.c`                                                | Redis 的 AOF 持久化实现代码。    |

另外还有一些独立功能的模块，在之后可以继续学习，他们功能独立。

| 文件                                                         | 内容                                            |
| :----------------------------------------------------------- | :---------------------------------------------- |
| `redis.h` 文件的 `pubsubPattern` 结构，以及 `pubsub.c` 文件。 | 发布与订阅功能的实现。                          |
| `redis.h` 文件的 `multiState` 结构以及 `multiCmd` 结构， `multi.c` 文件。 | 事务功能的实现。                                |
| `sort.c`                                                     | `SORT` 命令的实现。                             |
| `bitops.c`                                                   | `GETBIT` 、 `SETBIT` 等二进制位操作命令的实现。 |

第五步，阅读客户端和服务端的代码

知道了持久化之后，继续阅读c/s的相关代码。

| 文件                                                         | 内容                                                         |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| `ae.c` ，以及任意一个 `ae_*.c` 文件（取决于你所使用的多路复用库）。 | Redis 的事件处理器实现（基于 Reactor 模式）。                |
| `networking.c`                                               | Redis 的网络连接库，负责发送命令回复和接受命令请求， 同时也负责创建/销毁客户端， 以及通信协议分析等工作。 |
| `redis.h` 和 `redis.c` 中和单机 Redis 服务器有关的部分。     | 单机 Redis 服务器的实现。                                    |

另外有一些选读的部分

| 文件          | 内容                 |
| :------------ | :------------------- |
| `scripting.c` | Lua 脚本功能的实现。 |
| `slowlog.c`   | 慢查询功能的实现。   |
| `monitor.c`   | 监视器功能的实现。   |

第六步，阅读多机功能的实现

| 文件            | 内容                        |
| :-------------- | :-------------------------- |
| `replication.c` | 复制功能的实现代码。        |
| `sentinel.c`    | Redis Sentinel 的实现代码。 |
| `cluster.c`     | Redis 集群的实现代码。      |

因为 Redis Sentinel 用到了复制功能的代码， 而集群又用到了复制和 Redis Sentinel 的代码， 所以在阅读这三个模块的时候， 记得先阅读复制模块， 然后阅读 Sentinel 模块， 最后才阅读集群模块， 这样理解起来就会更得心应手。

## 总结

redis的设计简洁，代码精美。我0基础入门c++半年之后就可以尝试阅读。浅尝redis源码就深有收获。我觉得programming能力的进步离不开源码的学习，优秀的源码能boost你进步的过程。
